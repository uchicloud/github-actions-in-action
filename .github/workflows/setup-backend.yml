# Terraform BackendåˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¦DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã¨IAMãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ

name: Setup Terraform Backend

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: AWSèªè¨¼ï¼ˆOIDCï¼‰
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“Š DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
        run: |
          echo "DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆä¸­..."
          aws dynamodb create-table \
            --table-name terraform-state-lock \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ env.AWS_REGION }} 2>&1 | tee /tmp/dynamodb-output.txt || true

          if grep -q "ResourceInUseException" /tmp/dynamodb-output.txt; then
            echo "âœ… DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
          else
            echo "âœ… DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi

      - name: ğŸ” IAMãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ
        run: |
          cat > terraform-backend-policy.json <<'EOF'
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "TerraformStateS3Access",
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:PutObject",
                  "s3:DeleteObject",
                  "s3:ListBucket"
                ],
                "Resource": [
                  "arn:aws:s3:::651783364218-github-actions-tf-state",
                  "arn:aws:s3:::651783364218-github-actions-tf-state/*"
                ]
              },
              {
                "Sid": "TerraformStateLockDynamoDB",
                "Effect": "Allow",
                "Action": [
                  "dynamodb:DescribeTable",
                  "dynamodb:GetItem",
                  "dynamodb:PutItem",
                  "dynamodb:DeleteItem"
                ],
                "Resource": "arn:aws:dynamodb:${{ env.AWS_REGION }}:651783364218:table/terraform-state-lock"
              }
            ]
          }
          EOF

          echo "IAMãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆä¸­..."
          POLICY_ARN=$(aws iam create-policy \
            --policy-name TerraformBackendAccess \
            --policy-document file://terraform-backend-policy.json \
            --query 'Policy.Arn' \
            --output text 2>&1) || true

          if echo "$POLICY_ARN" | grep -q "EntityAlreadyExists"; then
            echo "âœ… IAMãƒãƒªã‚·ãƒ¼ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
            POLICY_ARN="arn:aws:iam::651783364218:policy/TerraformBackendAccess"
          else
            echo "âœ… IAMãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ: $POLICY_ARN"
          fi

          echo "POLICY_ARN=$POLICY_ARN" >> $GITHUB_ENV

      - name: ğŸ”— IAMãƒãƒªã‚·ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒ
        run: |
          echo "IAMãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒä¸­..."
          aws iam attach-role-policy \
            --role-name GitHubActionsDeployRole \
            --policy-arn ${{ env.POLICY_ARN }} 2>&1 | tee /tmp/attach-output.txt || true

          if grep -q "attached" /tmp/attach-output.txt || [ $? -eq 0 ]; then
            echo "âœ… IAMãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸  ãƒãƒªã‚·ãƒ¼ã¯æ—¢ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi

      - name: ğŸ“¦ S3ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–
        run: |
          echo "S3ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ä¸­..."
          aws s3api put-bucket-versioning \
            --bucket 651783364218-github-actions-tf-state \
            --versioning-configuration Status=Enabled

          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ"

      - name: âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Terraform Backend ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹:"
          echo "  ğŸ“Š DynamoDB: terraform-state-lock"
          echo "  ğŸ” IAM Policy: TerraformBackendAccess"
          echo "  ğŸ“¦ S3 Versioning: Enabled"
          echo ""
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "  1. æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤: Destroy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ"
          echo "  2. ãƒ‡ãƒ—ãƒ­ã‚¤: Deploy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™"
