# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# - OIDCèªè¨¼ã§AWSã«æ¥ç¶š
# - Terraformã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
# - é™çš„ã‚µã‚¤ãƒˆã‚’S3ã«ãƒ‡ãƒ—ãƒ­ã‚¤
# - Lambdaé–¢æ•°ã‚’æ›´æ–°

name: Deploy to AWS

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/setup-backend.yml'
      - '.github/workflows/destroy.yml'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

# OIDCèªè¨¼ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿å–ã‚Šã«å¿…è¦ãªæ¨©é™
permissions:
  id-token: write # OIDCèªè¨¼ç”¨
  contents: read # ãƒªãƒã‚¸ãƒˆãƒªã®å†…å®¹ã‚’èª­ã‚€

env:
  AWS_REGION: ap-northeast-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®ãƒ†ã‚¹ãƒˆ
  pre-deploy-test:
    runs-on: ubuntu-latest

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: pnpm test

  # ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: pre-deploy-test

    # Terraform outputsã‚’ä»–ã®ã‚¸ãƒ§ãƒ–ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    outputs:
      website_bucket: ${{ steps.terraform-output.outputs.website_bucket }}
      api_endpoint: ${{ steps.terraform-output.outputs.api_endpoint }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: AWSèªè¨¼ï¼ˆOIDCï¼‰
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraformã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: |
          terraform plan \
            -var="website_bucket_name=${{ secrets.WEBSITE_BUCKET_NAME }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Terraform Output
        id: terraform-output
        working-directory: terraform
        run: |
          echo "website_bucket=$(terraform output -raw website_bucket_name)" >> $GITHUB_OUTPUT
          echo "api_endpoint=$(terraform output -raw full_api_url)" >> $GITHUB_OUTPUT

  # é™çš„ã‚µã‚¤ãƒˆã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-website:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      - name: é™çš„ã‚µã‚¤ãƒˆã®ç”Ÿæˆ
        run: pnpm run ssg

      - name: AWSèªè¨¼ï¼ˆOIDCï¼‰
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: S3ã¸ã®åŒæœŸ
        run: |
          aws s3 sync dist/ s3://${{ secrets.WEBSITE_BUCKET_NAME }}/ \
            --delete \
            --cache-control "public, max-age=3600"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ: http://${{ secrets.WEBSITE_BUCKET_NAME }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
